Content-Type: text/x-zim-wiki
Wiki-Format: zim 0.4

====== PCR-799 Incorporation in Comanche 67 ======

([[comanche-67-reconstruction|Return to main Comanche 67 reconstruction page.]])

As usual, we do not have a copy of PCR-799, Verb 82 Time Option".

Using extended verb 82, after a bit of puttering around, results in a call to routine V82CALL in section R30. As it happens, we do have the [[https://www.ibiblio.org/apollo/Documents/E-2456-2D.pdf#page=1022|"COLOSSUS IIC" revision of flowchart FC-2650]], "Orbital Parameters Display", which covers V82CALL, and which we can thus compare to the Comanche 55 baseline to see where changes may have occurred. While I haven't done such a detailed comparison yet (because it's hard!), what almost immediately strikes me is that the code from V82GOFF1 to BOTHSHIP seems to differ substantially from the flowchart, and that that portion of the flowchart does seem to be relevant to a time option.

The next step that occurs to me is to diff the Comanche 55 vs Artemis versions of R30 from V82GOFF1 to BOTHSHIP. What I'd like to see is that that portion of Artemis corresponds to the flowchart and that all of the surrounding code in Artemis matches the surrounding code in Comanche 55. It's //sort of// what we see, but //not quite//:

* Most of the flowchart functionality is packed into a new subroutine, TIMEOPT, which the flowchart doesn't even mention.
* Conversely, the flowchart mentions labels (ISTIMEOK) which don't exist in the code. Given that ISTIMEOK doesn't exist in Comanche 55 or any other version of Colossus (or Luminary), it's not some overlooked legacy they forgot to remove from the flowchart and it's hard to see why the flowchart would bother to mention it. If the label was added in Comanche 67, why would it not be present in Artemis? Unless, of course, the code in Artemis had been rewritten from Comanche 67, in which case it's not valid to use the Artemis code as-is.

But perhaps flowchart FC-2650 is not as exact a match for the code as implemented as we like, and is simply correct regarding overall functionality. As it happens, our Colossus 2C flowchart book does contain the [[https://www.ibiblio.org/apollo/Documents/E-2456-2C.pdf#page=321|"COLOSSUS II" revision of FC-2650]]. In fact, R30 //code// is identical in MANCHE45R2 (Colossus 2) and Comanche055 (Colossus 2A), so this revision of FC-2650 is accurate for Colossus 2A. So we can look in it and see if ISTIMEOK existed then, and how closely the flowchart matches Colossus 2A code. In point of fact, the Colossus 2A R30 code matches the flowchart quite closely at this point, with the sole exception that the flowchart implies that a double-precision variable TIME2 is directly loaded by V82GOFF1, whereas the code instead calls a function (LOADTIME) unmentioned by the flowchart to load the single-precision variable TIME2 and convert it to double precision.

My conclusion from that is that the Artemis V82GOFF1 functionally matches the Colossus 2D flowchart for V82GOFF1, but in fact the code probably needs to be massaged somewhat to conform to the original Comanche 67 code. Most likely, the new TIMEOPT routine in Artemis doesn't exist in Colossus 2C, and needs to be inlined. The reason it is separated as its own subroutine in Artemis appears to be that it is called from a couple of places (both in R36 of section P34-P35, P74-P75) other than V82GOFF1. So if we could determine from the R36 flowchart for Colossus 2C that R36 isn't supposed to call TIMEOPT, we'd have a good argument for inlining. (Although inlining may not be such great news, since the code is partially interpretive and there may be multiple options for even/odd alignment of the interpretive instructions.)

R36 is covered by flowchart FC-2631:

* [[https://www.ibiblio.org/apollo/Documents/E-2456-2C.pdf#page=261|COLOSSUS IIA revision of FC-2631]].
* [[https://www.ibiblio.org/apollo/Documents/E-2456-2D.pdf#page=926|"Preliminary" COLOSSUS IID revision of FC-2631]].

There's no obvious point of agreement between the Colossus 2D FC-2631 and Artemis's R36. I see no references to TIMEOPT in the flowchart. TIMEOPT is not among the external subroutines listed in the table at the end of the flowchart, though there seem to be other external subroutines that are called which aren't mentioned either.

So my inference is that Artemis's TIMEOPT function has to be inlined in Comanche 67 V82GOFF1.

On making this change, I find that the changes had already been made, conditioned on the preprocessor label Reconstruction799, but that the changes had been essentially just importing Artemis code without inlining. This had a couple of other problems as side-effects, including the arbitrary way that the VEHRET variable needed by TIMEOPT was allocated, as well as an arbitrary selection of memory banks for holding TIMEOPT. With inlining those problems disappear, but we're left with the problem that memory bank 23, containing V82GOFF1, now overflows. The "goodness signature" is also nominally worse in other ways. However, I think this is now the correct (or much closer to correct) implementation.

In summary, the fix has been incorporated in code, but memory bank 23 now overflows and will have to eventually be reconciled in some way.

